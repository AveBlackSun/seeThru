/*! jQuery seeThru 21-04-2013 see https://github.com/m90/jquery-seeThru for details*/
(function(e){function t(t,a){var i=e("<canvas/>").attr({width:t.width,height:t.height}).get(0).getContext("2d");i.drawImage(a,0,0,t.width,t.height);for(var h=i.getImageData(0,0,t.width,t.height),n=3,r=h.data.length;r>n;n+=4)h.data[n-1]=h.data[n-2]=h.data[n-3]=h.data[n],h.data[n]=255;return h}var a={init:function(a){a||(a={});var i=e.extend({start:"autoplay",end:"loop",mask:"",alphaMask:!1,width:"",height:"",shimRAF:!0},a);return shimRAF&&function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;t.length>a&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var a=(new Date).getTime(),i=Math.max(0,16-(a-e)),h=window.setTimeout(function(){t(a+i)},i);return e=a+i,h}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),this.each(function(){e(this).data("seeThru")&&e.error("seeThru already initialized on selected element");var a,h=!1,n=i.alphaMask===!0;e(i.mask).length&&(a=e(i.mask)[0],"IMG"===a.tagName?(e(a).hide(),h=!0):e.error("Mask element must be <img>")),"VIDEO"===this.tagName?(e(this).bind("loadedmetadata.seeThru",function(){function r(e){g.drawImage(o,0,0,u.width,u.height*d);for(var t=g.getImageData(0,0,u.width,u.height),a=g.getImageData(0,u.height,u.width,u.height).data,h=3,n=t.data.length;n>h;h+=4)t.data[h]=i.alphaMask?a[h-1]:Math.max(a[h-1],a[h-2],a[h-3]);l.putImageData(t,0,0,0,0,u.width,u.height),e&&(w=requestAnimationFrame(function(){r(!0)}))}var s=e(this),o=this,d=(e(window),h?1:2),u={width:parseInt(i.width,10),height:parseInt(i.height,10)};u.height&&u.width||(s.attr("width")||s.attr("height")?s.attr("height")?s.attr("width")?(u.width=u.width||parseInt(o.width,10),u.height=u.height||parseInt(o.height,10)/d):(u.width=u.width||parseInt(o.height,10)*(o.videoWidth/Math.floor(o.videoHeight/d)),u.height=u.height||parseInt(o.height,10)):(u.width=u.width||parseInt(o.width,10),u.height=u.height||parseInt(o.width,10)/(o.videoWidth/Math.floor(o.videoHeight/d))):(u.width=u.width||o.videoWidth,u.height=u.height||o.videoHeight/d));var m=e("<canvas/>",{"class":"seeThru-buffer"}).attr({width:u.width,height:2*u.height}).hide(),c=e("<canvas/>",{"class":"seeThru-display"}).attr({width:u.width,height:u.height}),l=c[0].getContext("2d"),g=m[0].getContext("2d");c.bind("mouseenter mouseleave click mousedown mouseup mousemove mouseover hover dblclick contextmenu focus blur",function(e){s.trigger(e)}),h&&(a.width=u.width,a.height=u.height,n?g.putImageData(t(u,a),0,u.height):g.drawImage(a,0,u.height,u.width,u.height)),"stop"===i.end&&o.loop&&(o.loop=!1);var w;s.hide().data("seeThru",{staticMask:h,alphaMask:n,interval:w}).after(m,c),s.bind("play.seeThru",function(){cancelAnimationFrame(w),w=requestAnimationFrame(function(){r(!0)}),s.data("seeThru").interval=w}).bind("pause.seeThru",function(){cancelAnimationFrame(w)}),"autoplay"===i.start?s.trigger("play.seeThru"):"clicktoplay"===i.start?(o.play(),o.pause(),r(),c.one("click.seeThru",function(){o.play()})):"external"===i.start?(o.play(),o.pause(),s.bind("timeupdate.seeThru",function(){r()})):o.play(),"loop"===i.end?s.bind("ended.seeThru",function(){o.play()}):"rewind"===i.end?s.bind("ended.seeThru",function(){o.pause(),o.currentTime=0,"clicktoplay"==i.start&&c.one("click.seeThru",function(){o.play()})}):s.bind("ended.seeThru",function(){o.pause(),"clicktoplay"==i.start&&c.one("click.seeThru",function(){o.play()})})}),this.videoWidth&&this.videoHeight&&e(this).trigger("loadedmetadata.seeThru")):e.error("Selected element must be <video> element")})},updateMask:function(a){var i=e.extend({mask:""},a);return this.each(function(){var a=e(this);if(e(i.mask).length){var h=a.data("seeThru").staticMask,n=a.data("seeThru").alphaMask;if(h)if("IMG"===e(i.mask)[0].tagName){var r={width:a.width(),height:a.height()},s=e(i.mask)[0];s.width=r.width,s.height=r.height;var o=a.nextAll(".seeThru-buffer")[0].getContext("2d");n?o.putImageData(t(r,s),0,r.height):o.drawImage(s,0,r.height,r.width,r.height)}else e.error("Passed mask element must be <img>");else e.error("Cannot apply method '.updateMask()' to element with moving alpha")}else e.error("Missing parameter 'mask'")})},revert:function(){return this.each(function(){var t=e(this);t.data("seeThru")&&(cancelAnimationFrame(t.data("seeThru").interval),t.show().unbind(".seeThru").removeData("seeThru").nextAll(".seeThru-buffer:first, .seeThru-display:first").remove())})},play:function(){return this.each(function(){e(this).data("seeThru")&&this.play()})},pause:function(){return this.each(function(){e(this).data("seeThru")&&this.pause()})},rewind:function(){return this.each(function(){e(this).data("seeThru")&&(this.pause(),this.currentTime=0)})}};e.fn.seeThru=function(t){return a[t]?a[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?(e.error("Method "+t+" does not exist on jQuery.seeThru"),void 0):a.init.apply(this,arguments)}})(jQuery);